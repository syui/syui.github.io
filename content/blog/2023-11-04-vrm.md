+++
date = "2023-11-04"
tags = ["vrm","3d"]
title = "3d-modelとcardを連携してみた"
slug = "vrm"
+++

https://card.syui.ai/ai

### 動作環境

ios17で動作します。ios16では動作しません。

- [ok] ... ios17.x
- [no] ... ios16.x

`safari`の以下の機能が必要です。

ios17のデフォルトでは有効になっています。

- Allow WebGL in Web Workers
- GPU Process: Canvas Rendering
- GPU Process: DOM Rendering
- OffscreenCanvas in Workers
- OffscreenCanvas

### motionの作成

例えば、以下はblenderでポーズを編集している様子なんだけど、プレビューと出力結果が異なります。

![](https://raw.githubusercontent.com/syui/img/master/other/blender_20230908_0005.png)

![](https://raw.githubusercontent.com/syui/img/master/other/blender_20230908_0006.png)

これは、アニメーションが自動で動作するように設定されているためです。そのままvrmを読み込むとTポーズになりますが、[JLChnToZ/vrm-dance-viewer](https://github.com/JLChnToZ/vrm-dance-viewer)は設定で手を下げて固定します。

```ts:src/worker/vrm-idle-helper.ts
// https://github.com/JLChnToZ/vrm-dance-viewer
const LERP_SCALE = 6;

if (node) node.setRotationFromQuaternion(
        rotation3
        .setFromRotationMatrix(node.matrix)
        // ここがポーズをおかしくする要因
        // コメント化すると元通り。ただvrmを自然なポーズに固定する必要がでてくる
        //.slerp(finalRotation, Math.min(deltaTime * LERP_SCALE, 1)),
);
```

また、blinkを設定すると、顔を標準位置から移動するとおかしくなります。これは`three-vrm`の古いバージョンのバグです。

```ts:src/worker/vrm-idle-helper.ts
function updateEyeBlink(model: VRM, deltaTime: number) {
	//if (!model.blendShapeProxy) return;
	//let v = blinkDelays.get(model);
	//if (v == null || v < -BLINK_DURATION)
	//  v = MathUtils.randFloat(MIN_BLINK_DELAY, MAX_BLINK_DEALY);
	//else
	//  v -= deltaTime;
	//blinkDelays.set(model, v);
	//model.blendShapeProxy.setValue(
	//  VRMSchema.BlendShapePresetName.Blink,
	//  v > LOOK_CAMERA_THRESHOLD ? 0 : MathUtils.pingpong(-v, BLINK_DURATION / 2) * 2 / BLINK_DURATION,
	//);
}
```

これをどう自然に動かしていけばいいのか悩み中。全部のvrmをデフォルトのTポーズから変更するのもあんまり良くない。

`three.js`の他に`babylon.js`というものもあるらしい。こちらの[virtual-cast/babylon-vrm-loader](https://github.com/virtual-cast/babylon-vrm-loader)でvrmを読み込めます。

### link

- https://zenn.dev/ikkou/articles/fdb344a713cdf0/

- https://blog.virtualcast.jp/blog/2019/05/oss-browser-vrm-vci-viewer/
