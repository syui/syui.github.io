<!DOCTYPE html>
<html>
	<head>
		<title>goのentでapi serverを作ってみた | syui.github.io</title>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
		<meta name="author" content="syui" />
		<meta name="copyright" content="© syui" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="syui blog" />
		<meta name="keywords" content="syui, blog" />
		<meta name="twitter:card" content="summary" />
		<meta name="twitter:site" content="@syui__" />
		<meta name="robots" content="all" />
		<meta name="googlebot" content="all" />
		<meta property="og:type" content="blog" />
		<meta property="og:title" content="goのentでapi serverを作ってみた" />
		<meta property="og:locale" content="ja_JP" />
		<meta property="og:description" content="syui blog" />
		<meta property="og:image" content="https://syui.github.io//og.png" />
		<meta property="og:url" content="https://syui.github.io/blog/post/2022/02/23/golang/" />
		<meta property="og:site_name" content="syui.github.io" />
		<link rel="icon" href="/favicon.ico" />
		<link rel="shortcut icon" href="/favicon.ico">
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<link rel="stylesheet" href="/css/terminal.css" />
		<link rel="stylesheet" href="/css/style.css" />
		<link rel="stylesheet" href="/css/blog.css" />
		<link rel="stylesheet" href="/css/nav.css" />
		<link rel="stylesheet" href="/css/svg.css" />
		<link rel="stylesheet" href="/bower_components/icomoon/style.css" />
		<link rel="stylesheet" href="/bower_components/font-awesome/css/all.min.css" />
		<script type="application/ld+json">
			{
				"@context": "http://schema.org",
					"@type": "WebSite",
					"name": "syui.github.io",
					"url": "https:\/\/syui.github.io\/"
			}
		</script>

		<link rel="stylesheet" href="https://syui.github.io//bower_components/highlightjs/styles/monokai.css">
		<script src="https://syui.github.io//bower_components/highlightjs/highlight.pack.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="https://term.syui.ai/term/pkg/jquery.ajax/jquery.min.js"></script>
	</head>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
		<div class="navbar-nav">
			<span class="navbar-title-text"><a href="/"><span class="icon-syui"></span></a></span>
			<div class="navbar-nav-left">
				<a class="navbar-brand" href="/blog">ブログ</a>
				<a class="navbar-brand" href="/m">タグ</a>
				<a class="navbar-brand" href="/icon">アイコン</a>
				<a class="navbar-brand" href="/syui">プロフィール</a>
			</div>
		</div>
		<div class="navbar-nav-right">
		<a href="/blog/index.xml"><i class="fas fa-rss"></i></a>
		</div>
</nav>




<body>
	<div class="containerx">
		<header id="header">
			
			<div class="logo">
				<a href="/blog"><svg width="77pt" height="77pt" viewBox="0 0 512 512" class="likeButton" >
  <circle class="explosion" r="150" cx="250" cy="250"></circle>
  <g class="particleLayer">
    <circle fill="#ef454aba" cx="130" cy="126.5" r="12.5"/>
    <circle fill="#ef454acc" cx="411" cy="313.5" r="12.5"/>
    <circle fill="#ef454aba" cx="279" cy="86.5" r="12.5"/>
    <circle fill="#ef454aba" cx="155" cy="390.5" r="12.5"/>
    <circle fill="#ef454aba" cx="89" cy="292.5" r="10.5"/>
    <circle fill="#ef454aba" cx="414" cy="282.5" r="10.5"/>
    <circle fill="#ef454a91" cx="115" cy="149.5" r="10.5"/>
    <circle fill="#ef454aba" cx="250" cy="80.5" r="10.5"/>
    <circle fill="#ef454aba" cx="78" cy="261.5" r="10.5"/>
    <circle fill="#ef454a91" cx="182" cy="402.5" r="10.5"/>
    <circle fill="#ef454aba" cx="401.5" cy="166" r="13"/>
    <circle fill="#ef454aba" cx="379" cy="141.5" r="10.5"/>
    <circle fill="#ef454a91" cx="327" cy="397.5" r="10.5"/>
    <circle fill="#ef454aba" cx="296" cy="392.5" r="10.5"/>
  </g>
<g transform="translate(0,512) scale(0.1,-0.1)" fill="#000000" class="icon_syui">

<path class="syui" d="M3660 4460 c-11 -11 -33 -47 -48 -80 l-29 -60 -12 38 c-27 88 -58 92 -98 11 -35 -70 -73 -159 -73 -169 0 -6 -5 -10 -10 -10 -6 0 -15 -10 -21 -22 -33 -73 -52 -92 -47 -48 2 26 -1 35 -14 38 -16 3 -168 -121 -168 -138 0 -5 -13 -16 -28 -24 -24 -13 -35 -12 -87 0 -221 55 -231 56 -480 56 -219 1 -247 -1 -320 -22 -44 -12 -96 -26 -115 -30 -57 -13 -122 -39 -200 -82 -8 -4 -31 -14 -50 -23 -41 -17 -34 -13 -146 -90 -87 -59 -292 -252 -351 -330 -63 -83 -143 -209 -143 -225 0 -10 -7 -23 -15 -30 -8 -7 -15 -17 -15 -22 0 -5 -13 -37 -28 -71 -16 -34 -36 -93 -45 -132 -9 -38 -24 -104 -34 -145 -13 -60 -17 -121 -17 -300 1 -224 1 -225 36 -365 24 -94 53 -175 87 -247 28 -58 51 -108 51 -112 0 -3 13 -24 28 -48 42 -63 46 -79 22 -85 -11 -3 -20 -9 -20 -14 0 -5 -4 -9 -10 -9 -5 0 -22 -11 -37 -25 -16 -13 -75 -59 -133 -100 -58 -42 -113 -82 -123 -90 -9 -8 -22 -15 -27 -15 -6 0 -10 -6 -10 -13 0 -8 -11 -20 -25 -27 -34 -18 -34 -54 0 -48 14 3 25 2 25 -1 0 -3 -43 -31 -95 -61 -52 -30 -95 -58 -95 -62 0 -5 -5 -8 -11 -8 -19 0 -84 -33 -92 -47 -4 -7 -15 -13 -22 -13 -14 0 -17 -4 -19 -32 -1 -8 15 -15 37 -18 l38 -5 -47 -48 c-56 -59 -54 -81 9 -75 30 3 45 0 54 -11 9 -13 16 -14 43 -4 29 11 30 10 18 -5 -7 -9 -19 -23 -25 -30 -7 -7 -13 -20 -13 -29 0 -12 8 -14 38 -9 20 4 57 8 82 9 25 2 54 8 66 15 18 10 23 8 32 -13 17 -38 86 -35 152 6 27 17 50 34 50 38 0 16 62 30 85 19 33 -15 72 -2 89 30 8 15 31 43 51 62 35 34 38 35 118 35 77 0 85 2 126 33 24 17 52 32 61 32 9 0 42 18 73 40 30 22 61 40 69 40 21 0 88 -26 100 -38 7 -7 17 -12 24 -12 7 0 35 -11 62 -25 66 -33 263 -84 387 -101 189 -25 372 -12 574 41 106 27 130 37 261 97 41 20 80 37 85 39 6 2 51 31 100 64 166 111 405 372 489 534 10 20 22 43 27 51 5 8 12 22 15 30 3 8 17 40 31 70 54 115 95 313 108 520 13 200 -43 480 -134 672 -28 58 -51 108 -51 112 0 3 -13 24 -29 48 -15 24 -34 60 -40 80 -19 57 3 142 50 193 10 11 22 49 28 85 6 36 16 67 21 68 18 6 31 53 25 83 -4 18 -17 33 -36 41 -16 7 -29 15 -29 18 1 10 38 50 47 50 5 0 20 11 33 25 18 19 22 31 17 61 -3 20 -14 45 -23 55 -16 18 -16 20 6 44 15 16 21 32 18 49 -3 15 1 34 8 43 32 43 7 73 -46 55 l-30 -11 0 85 c0 74 -2 84 -18 84 -21 0 -53 -33 -103 -104 l-34 -48 -5 74 c-7 102 -35 133 -80 88z m-870 -740 c36 -7 75 -14 88 -16 21 -4 23 -9 16 -37 -3 -18 -14 -43 -24 -57 -10 -14 -20 -35 -24 -46 -4 -12 -16 -32 -27 -45 -12 -13 -37 -49 -56 -79 -20 -30 -52 -73 -72 -96 -53 -60 -114 -133 -156 -189 -21 -27 -44 -54 -52 -58 -7 -4 -13 -14 -13 -22 0 -7 -18 -33 -40 -57 -22 -23 -40 -46 -40 -50 0 -5 -19 -21 -42 -38 -47 -35 -85 -38 -188 -15 -115 25 -173 20 -264 -23 -45 -22 -106 -46 -136 -56 -48 -15 -77 -25 -140 -50 -70 -28 -100 -77 -51 -84 14 -2 34 -10 45 -17 12 -7 53 -16 91 -20 90 -9 131 -22 178 -57 20 -16 52 -35 70 -43 18 -7 40 -22 49 -32 16 -18 15 -22 -24 -88 -23 -39 -47 -74 -53 -80 -7 -5 -23 -26 -36 -45 -26 -39 -92 -113 -207 -232 -4 -4 -37 -36 -73 -71 l-66 -64 -20 41 c-58 119 -105 240 -115 301 -40 244 -35 409 20 595 8 30 21 66 28 80 7 14 24 54 38 89 15 35 35 75 46 89 11 13 20 31 20 38 0 8 3 14 8 14 4 0 16 16 27 36 24 45 221 245 278 281 23 15 44 30 47 33 20 20 138 78 250 123 61 24 167 50 250 61 60 7 302 -1 370 -14z m837 -661 c52 -101 102 -279 106 -379 2 -42 0 -45 -28 -51 -16 -4 -101 -7 -187 -8 -166 -1 -229 10 -271 49 -19 19 -19 19 14 49 22 21 44 31 65 31 41 0 84 34 84 66 0 30 12 55 56 112 19 25 37 65 44 95 11 51 53 111 74 104 6 -2 25 -32 43 -68z m-662 -810 c17 -10 40 -24 53 -30 12 -7 22 -16 22 -20 0 -4 17 -13 38 -19 20 -7 44 -18 52 -24 8 -7 33 -21 55 -31 22 -11 42 -23 45 -26 11 -14 109 -49 164 -58 62 -11 101 -7 126 14 15 14 38 18 78 16 39 -2 26 -41 -49 -146 -78 -109 -85 -118 -186 -219 -61 -61 -239 -189 -281 -203 -17 -5 -73 -29 -104 -44 -187 -92 -605 -103 -791 -21 -42 19 -47 24 -37 41 5 11 28 32 51 48 22 15 51 38 64 51 13 12 28 22 33 22 17 0 242 233 242 250 0 6 5 10 10 10 6 0 10 6 10 14 0 25 50 55 100 62 59 8 56 6 115 83 50 66 74 117 75 162 0 14 7 40 16 57 18 38 52 41 99 11z"/>
</g>

</svg>
</a>
			</div>
			
		</header>

<article>
	<div class="content">
		
		<div class="post-time-date">2022-02-23 / <a href="https://bsky.syui.ai">@syui</a>

		
		
		<p><i class="fa-regular fa-folder"></i> 
		<a href="https://syui.github.io/tags/go/">go</a>
		
		
		
		
		
		
		
		</div>

		<h2>goのentでapi serverを作ってみた</h2>

		<p>最初は、<a href="https://github.com/go-gorm/gorm">gorm</a>を使っていました。</p>
<p>gormは非常に見通しがよく、わかりやすかったです。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;aicard/database&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;github.com/labstack/echo/v4&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;gorm.io/gorm&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Id</span>    <span style="color:#66d9ef">int</span>    <span style="color:#e6db74">`json:&#34;id&#34; param:&#34;id&#34; gorm:&#34;primary_key&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34; gorm:&#34;unique,collate:utf8,length:7`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">CreatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">UpdatedAt</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DeletedAt</span> <span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DeletedAt</span> <span style="color:#e6db74">`gorm:&#34;index&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">hello</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">String</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#e6db74">&#34;Hello, World!&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getUsers</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">users</span> <span style="color:#f92672">:=</span> []<span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Find</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">users</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">users</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Take</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">updateUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Where</span>(<span style="color:#e6db74">&#34;id = ?&#34;</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">First</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>).<span style="color:#a6e22e">Error</span>; <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Save</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">createUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">User</span>{}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Bind</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">JSON</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusCreated</span>, <span style="color:#a6e22e">user</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">deleteUser</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">Context</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">id</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Param</span>(<span style="color:#e6db74">&#34;id&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Delete</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">User</span>{}, <span style="color:#a6e22e">id</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NoContent</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusNoContent</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">echo</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">Connect</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sqlDB</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">database</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">DB</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">sqlDB</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">hello</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/users&#34;</span>, <span style="color:#a6e22e">getUsers</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">GET</span>(<span style="color:#e6db74">&#34;/users/:id&#34;</span>, <span style="color:#a6e22e">getUser</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">PUT</span>(<span style="color:#e6db74">&#34;/users/:id&#34;</span>, <span style="color:#a6e22e">updateUser</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">POST</span>(<span style="color:#e6db74">&#34;/users&#34;</span>, <span style="color:#a6e22e">createUser</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">DELETE</span>(<span style="color:#e6db74">&#34;/users/:id&#34;</span>, <span style="color:#a6e22e">deleteUser</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;PORT&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">port</span> = <span style="color:#e6db74">&#34;1323&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">port</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>しかし、<code>ent@0.9.0</code>に追加されたような<code>onconflict</code>の仕組みがなかったので、<a href="https://entgo.io/ja/docs/code-gen/">ent</a>を使いはじめました。</p>
<p><code>onconflict</code>は、dbに既に一致するdateがある場合、errを出してくれます。これによって、例えば、同じユーザー名では登録できないようにすることが可能です。もちろん、gormでも可能ですが、entのほうが簡単にできます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/http/create.go" data-lang="go:ent/http/create.go"><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">User</span>.<span style="color:#a6e22e">Create</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">SetUsername</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Username</span>).<span style="color:#a6e22e">OnConflict</span>()
</span></span></code></pre></div><p>それでは、entの基本的な使い方を紹介していきたいと思います。</p>
<p>まずは、project-dirを作り、その中にgo.modを作ります。<code>go get</code>などする際は依存関連が示されるgo.sumが更新されていきます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mkdir t
</span></span><span style="display:flex;"><span>$ cd t
</span></span><span style="display:flex;"><span>$ go mod init $project
</span></span><span style="display:flex;"><span>$ cat go.mod
</span></span></code></pre></div><p>なお、herokuにdeployする際は、<code>go.mod</code>には以下のようにverを指定してやらなければいけません。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:go.mod" data-lang="go:go.mod"><span style="display:flex;"><span>module t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// +heroku goVersion go1.17
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>go <span style="color:#ae81ff">1.17</span>
</span></span></code></pre></div><p>go.modのmoduleの名前は、ent/以下のファイルをimportする際に使います。ここでは、project-nameを<code>t</code>としています。例えば、ent/entryをimportしたい場合は、<code>t/ent/entry</code>というpathを指定することになります。</p>
<p>entはschemaに作成されたファイルからコントロールし、dbのデータをclientと受け渡しする仕組みを構築できます。schemaを書きかえたら都度、go generateでコードファイルを更新できます。追加機能などもこの仕組からコードファイルに追記されていきます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/generate.go" data-lang="go:ent/generate.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">ent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate ./schema
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate --feature sql/upsert ./schema
</span></span></span></code></pre></div><p>go mod initでgo.modを作成できたら、entをインストールして、entcコマンドを使えるようにします。通常はgoを使用しているとインストールされるbinaryにはpathが通っているはずですが、通っていなくても<code>go run</code>からurlを指定すれば実行可能です。</p>
<p>なお、<code>go mod init</code>や<code>ent init</code>で指定した名前は各ファイルに書かれますので適切なものにしてください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get -d entgo.io/ent/cmd/ent
</span></span><span style="display:flex;"><span>$ ent init Entry
</span></span><span style="display:flex;"><span>or
</span></span><span style="display:flex;"><span>$ go run entgo.io/ent/cmd/ent init Entry
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── ent
</span></span><span style="display:flex;"><span>│   ├── generate.go
</span></span><span style="display:flex;"><span>│   └── schema
</span></span><span style="display:flex;"><span>│       └── entry.go
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>└── go.sum
</span></span></code></pre></div><p>ここで、entの通常の開発手順としては、(1)<code>entc init</code>してschemaを作成する、(2)<code>ent/schema/*.go</code>を編集する、(3)<code>go generate ./ent</code>を実行する、(4)<code>main.go</code>などのメインファイルからclientを操作する、(5)<code>go run</code>や<code>go build</code>する、という流れになります。</p>
<p>ということで、次は<code>ent/schema/entry.go</code>を書きます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/schema/entry.go" data-lang="go:ent/schema/entry.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">schema</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent/schema/field&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Fields of the User.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">Fields</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;age&#34;</span>).
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Positive</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;name&#34;</span>).
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">Default</span>(<span style="color:#e6db74">&#34;unknown&#34;</span>),
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>project-rootから<code>go generate ./ent</code>を実行します。すると、先程、initした名前のファイル、<code>entry*.go</code>が作成されています。これらをimportすることで、開発者は<code>schema</code>と<code>main</code>の編集に集中できるという感じになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go generate ./ent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── ent
</span></span><span style="display:flex;"><span>│   ├── client.go
</span></span><span style="display:flex;"><span>│   ├── config.go
</span></span><span style="display:flex;"><span>│   ├── context.go
</span></span><span style="display:flex;"><span>│   ├── ent.go
</span></span><span style="display:flex;"><span>│   ├── entry
</span></span><span style="display:flex;"><span>│   │   ├── entry.go
</span></span><span style="display:flex;"><span>│   │   └── where.go
</span></span><span style="display:flex;"><span>│   ├── entry.go
</span></span><span style="display:flex;"><span>│   ├── entry_create.go
</span></span><span style="display:flex;"><span>│   ├── entry_delete.go
</span></span><span style="display:flex;"><span>│   ├── entry_query.go
</span></span><span style="display:flex;"><span>│   ├── entry_update.go
</span></span><span style="display:flex;"><span>│   ├── enttest
</span></span><span style="display:flex;"><span>│   │   └── enttest.go
</span></span><span style="display:flex;"><span>│   ├── generate.go
</span></span><span style="display:flex;"><span>│   ├── hook
</span></span><span style="display:flex;"><span>│   │   └── hook.go
</span></span><span style="display:flex;"><span>│   ├── migrate
</span></span><span style="display:flex;"><span>│   │   ├── migrate.go
</span></span><span style="display:flex;"><span>│   │   └── schema.go
</span></span><span style="display:flex;"><span>│   ├── mutation.go
</span></span><span style="display:flex;"><span>│   ├── predicate
</span></span><span style="display:flex;"><span>│   │   └── predicate.go
</span></span><span style="display:flex;"><span>│   ├── runtime
</span></span><span style="display:flex;"><span>│   │   └── runtime.go
</span></span><span style="display:flex;"><span>│   ├── runtime.go
</span></span><span style="display:flex;"><span>│   ├── schema
</span></span><span style="display:flex;"><span>│   │   └── entry.go
</span></span><span style="display:flex;"><span>│   └── tx.go
</span></span><span style="display:flex;"><span>├── go.mod
</span></span><span style="display:flex;"><span>└── go.sum
</span></span></code></pre></div><p>次は、clientを操作する<code>main.go</code>を作成していきます。project-rootにmain.goを置き、それをbuildします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;t/ent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>,<span style="color:#e6db74">&#34;host=&lt;host&gt; port=&lt;port&gt; user=&lt;user&gt; dbname=&lt;database&gt; password=&lt;pass&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build
</span></span><span style="display:flex;"><span>$ ./t
</span></span></code></pre></div><p>特に重要になる部分は以下のような書き方がされる箇所です。apiへpostされたdateを受け取り、それをdbに保存し、返すための処理を書くのに使われることが多い。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entry</span>.<span style="color:#a6e22e">Create</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">SetUser</span>()
</span></span></code></pre></div><p>また、各種ファイルでのimportはproject-nameからのpathとなります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;t/ent&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#e6db74">&#34;t/ent/entry&#34;</span>
</span></span><span style="display:flex;"><span>		)
</span></span></code></pre></div><p>もちろん、projectをgithubにおいているなら、<code>github.com/$USER/$PROJECT/ent</code>としてもいいです。この場合、go.modのmoduleもそのように書き換えてください。</p>
<p>ここまでがentの基本的な部分です。ここからは、<code>heroku-postgres</code>や<code>onconflict</code>に対応します。herokuはportが変わりますので、envから受け取らなければなりません。</p>
<p>まずは、heroku-postgresに対応します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ent/schema/entry.go" data-lang="ent/schema/entry.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">schema</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent/schema/field&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Entry</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Schema</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">Entry</span>) <span style="color:#a6e22e">Fields</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;user&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">MaxLen</span>(<span style="color:#ae81ff">8</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Unique</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Immutable</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;first&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Unique</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Immutable</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Time</span>(<span style="color:#e6db74">&#34;created_at&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Immutable</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Default</span>(<span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>		}),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">Entry</span>) <span style="color:#a6e22e">Edges</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Edge</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;t/ent&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;database/sql&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">entsql</span> <span style="color:#e6db74">&#34;entgo.io/ent/dialect/sql&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent/dialect&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/jackc/pgx/v4/stdlib&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;user&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">first</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;first&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">created_at</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#e6db74">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">databaseUrl</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Client</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;pgx&#34;</span>, <span style="color:#a6e22e">databaseUrl</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">drv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">entsql</span>.<span style="color:#a6e22e">OpenDB</span>(<span style="color:#a6e22e">dialect</span>.<span style="color:#a6e22e">Postgres</span>, <span style="color:#a6e22e">db</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Driver</span>(<span style="color:#a6e22e">drv</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;DATABASE_URL&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?sslmode=require&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Schema</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build
</span></span></code></pre></div><p>次に、<code>onconflict</code>への対応です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/generate.go" data-lang="go:ent/generate.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">ent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate ./schema
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate go run -mod=mod entgo.io/ent/cmd/ent generate --feature sql/upsert ./schema
</span></span></span></code></pre></div><pre tabindex="0"><code>$ go generate ./...
</code></pre><p>これで<code>onconflict</code>が使えるようになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Entry</span>.<span style="color:#a6e22e">Create</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">SetUser</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">User</span>).<span style="color:#a6e22e">OnConflict</span>()
</span></span></code></pre></div><p>例えば、作成したapiにpostすると、同じ名前にはerrを返すようになります。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -X <span style="color:#e6db74">&#39;POST&#39;</span> -H <span style="color:#e6db74">&#39;Content-Type: application/json&#39;</span> -d <span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;syui&#34;}&#39;</span> <span style="color:#e6db74">&#34;https://</span>$APP<span style="color:#e6db74">.herokuapp.com/u&#34;</span>
</span></span><span style="display:flex;"><span>...ok
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ !!
</span></span><span style="display:flex;"><span>...err
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ heroku logs
</span></span></code></pre></div><p>herokuにdeployする場合は、<code>.gitignore</code>を書いて、<code>git push</code>します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cat .gitignore
</span></span><span style="display:flex;"><span>*.db
</span></span><span style="display:flex;"><span>t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git init
</span></span><span style="display:flex;"><span>$ heroku git:remote -a $APP
</span></span><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#34;first&#34;</span>
</span></span><span style="display:flex;"><span>$ git push -u heroku main
</span></span></code></pre></div><p>ここからは、entで作るopen-apiの作り方を紹介します。基本的には、<code>ent/entc.go</code>を作成し、genarateします。</p>
<p>実は、entでopen-apiの作成はなかなかに面倒で、gormのほうが基本的にはわかりやすく、コードも見通しが良いものになるでしょう。ですが、規模が大きくなると、entのほうがよいapiを作れるのではないかと思います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/entc.go" data-lang="go:ent/entc.go"><span style="display:flex;"><span><span style="color:#75715e">//go:build ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/contrib/entoas&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent/entc&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent/entc/gen&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ariga/ogent&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;github.com/ogen-go/ogen&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spec</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">ogen</span>.<span style="color:#a6e22e">Spec</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">oas</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">entoas</span>.<span style="color:#a6e22e">NewExtension</span>(<span style="color:#a6e22e">entoas</span>.<span style="color:#a6e22e">Spec</span>(<span style="color:#a6e22e">spec</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;creating entoas extension: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ogent</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ogent</span>.<span style="color:#a6e22e">NewExtension</span>(<span style="color:#a6e22e">spec</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;creating ogent extension: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">entc</span>.<span style="color:#a6e22e">Generate</span>(<span style="color:#e6db74">&#34;./schema&#34;</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gen</span>.<span style="color:#a6e22e">Config</span>{}, <span style="color:#a6e22e">entc</span>.<span style="color:#a6e22e">Extensions</span>(<span style="color:#a6e22e">ogent</span>, <span style="color:#a6e22e">oas</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatalf</span>(<span style="color:#e6db74">&#34;running ent codegen: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get entgo.io/contrib/entoas ariga.io/ogent
</span></span><span style="display:flex;"><span>$ entc init Todo
</span></span><span style="display:flex;"><span>$ vim ent/schema/todo.go
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/schema/todo.go" data-lang="go:ent/schema/todo.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">schema</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;entgo.io/ent/schema/field&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Todo holds the schema definition for the Todo entity.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Todo</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Schema</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Fields of the Todo.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">Todo</span>) <span style="color:#a6e22e">Fields</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;title&#34;</span>),
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Bool</span>(<span style="color:#e6db74">&#34;done&#34;</span>).
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">Optional</span>(),
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最初に作ったentryは削除します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ rm -rf ent/entry*
</span></span><span style="display:flex;"><span>$ rm -rf ent/schema/entry*
</span></span></code></pre></div><p>続いて、ent/entc.goからファイルを再構成します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/genarate.go" data-lang="go:ent/genarate.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">ent</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//go:generate go run -mod=mod entc.go
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go generate ./...
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:main.go" data-lang="go:main.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;t/ent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;context&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;database/sql&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">entsql</span> <span style="color:#e6db74">&#34;entgo.io/ent/dialect/sql&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent/dialect&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/jackc/pgx/v4/stdlib&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> <span style="color:#e6db74">&#34;github.com/lib/pq&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;t/ent/ogent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent/dialect/sql/schema&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">user</span> <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;user&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">first</span> <span style="color:#66d9ef">int</span> <span style="color:#e6db74">`json:&#34;first&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">created_at</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> <span style="color:#e6db74">`json:&#34;created_at&#34;`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">databaseUrl</span> <span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Client</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;pgx&#34;</span>, <span style="color:#a6e22e">databaseUrl</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">drv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">entsql</span>.<span style="color:#a6e22e">OpenDB</span>(<span style="color:#a6e22e">dialect</span>.<span style="color:#a6e22e">Postgres</span>, <span style="color:#a6e22e">db</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Driver</span>(<span style="color:#a6e22e">drv</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">url</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;DATABASE_URL&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?sslmode=require&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;postgres&#34;</span>, <span style="color:#a6e22e">url</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//client, err := Open(url)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Schema</span>.<span style="color:#a6e22e">Create</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">schema</span>.<span style="color:#a6e22e">WithAtlas</span>(<span style="color:#66d9ef">true</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">port</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;PORT&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">port</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">port</span> = <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span>,<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ogent</span>.<span style="color:#a6e22e">NewServer</span>(<span style="color:#a6e22e">ogent</span>.<span style="color:#a6e22e">NewOgentHandler</span>(<span style="color:#a6e22e">client</span>))
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">port</span>, <span style="color:#a6e22e">srv</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get t
</span></span><span style="display:flex;"><span>$ go run -mod<span style="color:#f92672">=</span>mod main.go
</span></span><span style="display:flex;"><span>or
</span></span><span style="display:flex;"><span>$ go build
</span></span><span style="display:flex;"><span>$ ./t
</span></span><span style="display:flex;"><span>--------------------
</span></span><span style="display:flex;"><span>$ curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;title&#34;:&#34;Give ogen and ogent a Star on GitHub&#34;}&#39;</span> localhost:8080/todos
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>:1,<span style="color:#e6db74">&#34;title&#34;</span>:<span style="color:#e6db74">&#34;Give ogen and ogent a Star on GitHub&#34;</span>,<span style="color:#e6db74">&#34;done&#34;</span>:false<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>できました。</p>
<p>次は、userを作成するapiを作ってみます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ entc init Users
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go:ent/schema/users.go" data-lang="go:ent/schema/users.go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">schema</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;entgo.io/ent/schema/field&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Users</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Schema</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">Users</span>) <span style="color:#a6e22e">Fields</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Field</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">String</span>(<span style="color:#e6db74">&#34;user&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">NotEmpty</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Immutable</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">MaxLen</span>(<span style="color:#ae81ff">7</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Unique</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;first&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Optional</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Int</span>(<span style="color:#e6db74">&#34;draw&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Optional</span>(),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Time</span>(<span style="color:#e6db74">&#34;created_at&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Optional</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Default</span>(<span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>		}),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Time</span>(<span style="color:#e6db74">&#34;updated_at&#34;</span>).
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Optional</span>().
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Default</span>(<span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>()
</span></span><span style="display:flex;"><span>		}),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">Users</span>) <span style="color:#a6e22e">Edges</span>() []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Edge</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> []<span style="color:#a6e22e">ent</span>.<span style="color:#a6e22e">Edge</span>{}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go generate ./...
</span></span><span style="display:flex;"><span>$ go run -mod<span style="color:#f92672">=</span>mod main.go
</span></span><span style="display:flex;"><span>--------------------
</span></span><span style="display:flex;"><span>$ curl -X POST -H <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#e6db74">&#39;{&#34;user&#34;:&#34;syui&#34;}&#39;</span> localhost:8080/users
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>:1,<span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;syui&#34;</span>,<span style="color:#e6db74">&#34;first&#34;</span>:0,<span style="color:#e6db74">&#34;draw&#34;</span>:0,<span style="color:#e6db74">&#34;created_at&#34;</span>:<span style="color:#e6db74">&#34;2022-02-24T10:15:33Z&#34;</span>,<span style="color:#e6db74">&#34;updated_at&#34;</span>:<span style="color:#e6db74">&#34;2022-02-24T10:15:33Z&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ !!
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;code&#34;</span>:409,<span style="color:#e6db74">&#34;status&#34;</span>:<span style="color:#e6db74">&#34;Conflict&#34;</span>,<span style="color:#e6db74">&#34;errors&#34;</span>:<span style="color:#e6db74">&#34;ent: constraint failed: pq: duplicate key value violates unique constraint \&#34;users_user_key\&#34;&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ curl localhost:8080/users/1
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>:1,<span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;syui&#34;</span>,<span style="color:#e6db74">&#34;first&#34;</span>:0,<span style="color:#e6db74">&#34;draw&#34;</span>:0,<span style="color:#e6db74">&#34;created_at&#34;</span>:<span style="color:#e6db74">&#34;2022-02-24T10:15:33Z&#34;</span>,<span style="color:#e6db74">&#34;updated_at&#34;</span>:<span style="color:#e6db74">&#34;2022-02-24T10:15:33Z&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>以上がentでopen-apiを作成する基本的な手順になると思われます。</p>
<p>entは、最初はとっつきにくいですが、触っているうちに慣れてくると思うので、おすすめです。</p>
<h4 id="ref-">ref :</h4>
<ul>
<li>
<p><a href="https://entgo.io/ja/docs/tutorial-setup">https://entgo.io/ja/docs/tutorial-setup</a></p>
</li>
<li>
<p><a href="https://entgo.io/ja/blog/2021/08/05/announcing-upsert-api/">https://entgo.io/ja/blog/2021/08/05/announcing-upsert-api/</a></p>
</li>
<li>
<p><a href="https://entgo.io/ja/blog/2021/09/10/openapi-generator/">https://entgo.io/ja/blog/2021/09/10/openapi-generator/</a></p>
</li>
<li>
<p><a href="https://entgo.io/ja/blog/2022/02/15/generate-rest-crud-with-ent-and-ogen/">https://entgo.io/ja/blog/2022/02/15/generate-rest-crud-with-ent-and-ogen/</a></p>
</li>
</ul>


		

	</div>

</article>




</div>
		<div class="footer-link">
	<span class="footer-link"><a href="https://syu.is/syui" target="_blank"><i class="fab fa-bluesky"></i></a></span>
		<span class="footer-link"><a href="https://card.syui.ai/syui" target="_blank"><span class="icon-ai"></span></a></span>
	<span class="footer-link"><a href="https://git.syui.ai/syui" target="_blank"><span class="icon-git"></span></a></span>
</div>

<script src="/js/svg.js"></script>
<script src="/js/highlight-filename.js"></script>
<footer id="footer">© syui</footer>

	</body>
</html>
