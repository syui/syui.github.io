<!DOCTYPE html>
<html>
	<head>
		<title>atprotoのfrontpageを触ってみる | syui.github.io</title>
		<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
		<meta name="author" content="syui" />
		<meta name="copyright" content="© syui" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="syui blog" />
		<meta name="keywords" content="syui, blog" />
		<meta name="twitter:card" content="summary" />
		<meta name="twitter:site" content="@syui__" />
		<meta name="robots" content="all" />
		<meta name="googlebot" content="all" />
		<meta property="og:type" content="blog" />
		<meta property="og:title" content="atprotoのfrontpageを触ってみる" />
		<meta property="og:locale" content="ja_JP" />
		<meta property="og:description" content="syui blog" />
		<meta property="og:image" content="https://syui.github.io//og.png" />
		<meta property="og:url" content="https://syui.github.io/blog/post/2024/10/26/frontpage/" />
		<meta property="og:site_name" content="syui.github.io" />
		<link rel="icon" href="/favicon.ico" />
		<link rel="shortcut icon" href="/favicon.ico">
		<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
		<link rel="stylesheet" href="/css/terminal.css" />
		<link rel="stylesheet" href="/css/style.css" />
		<link rel="stylesheet" href="/css/blog.css" />
		<link rel="stylesheet" href="/css/nav.css" />
		<link rel="stylesheet" href="/css/svg.css" />
		<link rel="stylesheet" href="/bower_components/icomoon/style.css" />
		<link rel="stylesheet" href="/bower_components/font-awesome/css/all.min.css" />
		<script type="application/ld+json">
			{
				"@context": "http://schema.org",
					"@type": "WebSite",
					"name": "syui.github.io",
					"url": "https:\/\/syui.github.io\/"
			}
		</script>

		<link rel="stylesheet" href="https://syui.github.io//bower_components/highlightjs/styles/monokai.css">
		<script src="https://syui.github.io//bower_components/highlightjs/highlight.pack.min.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
		<script src="https://term.syui.ai/term/pkg/jquery.ajax/jquery.min.js"></script>
	</head>

<nav class="navbar navbar-expand-lg navbar-light bg-light">
	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
		<div class="navbar-nav">
			<span class="navbar-title-text"><a href="/"><span class="icon-syui"></span></a></span>
			<div class="navbar-nav-left">
				<a class="navbar-brand" href="/blog">ブログ</a>
				<a class="navbar-brand" href="/m">タグ</a>
				<a class="navbar-brand" href="/icon">アイコン</a>
				<a class="navbar-brand" href="/syui">プロフィール</a>
			</div>
		</div>
		<div class="navbar-nav-right">
		<a href="/blog/index.xml"><i class="fas fa-rss"></i></a>
		</div>
</nav>




<body>
	<div class="containerx">
		<header id="header">
			
			<div class="logo">
				<a href="/blog"><svg width="77pt" height="77pt" viewBox="0 0 512 512" class="likeButton" >
  <circle class="explosion" r="150" cx="250" cy="250"></circle>
  <g class="particleLayer">
    <circle fill="#ef454aba" cx="130" cy="126.5" r="12.5"/>
    <circle fill="#ef454acc" cx="411" cy="313.5" r="12.5"/>
    <circle fill="#ef454aba" cx="279" cy="86.5" r="12.5"/>
    <circle fill="#ef454aba" cx="155" cy="390.5" r="12.5"/>
    <circle fill="#ef454aba" cx="89" cy="292.5" r="10.5"/>
    <circle fill="#ef454aba" cx="414" cy="282.5" r="10.5"/>
    <circle fill="#ef454a91" cx="115" cy="149.5" r="10.5"/>
    <circle fill="#ef454aba" cx="250" cy="80.5" r="10.5"/>
    <circle fill="#ef454aba" cx="78" cy="261.5" r="10.5"/>
    <circle fill="#ef454a91" cx="182" cy="402.5" r="10.5"/>
    <circle fill="#ef454aba" cx="401.5" cy="166" r="13"/>
    <circle fill="#ef454aba" cx="379" cy="141.5" r="10.5"/>
    <circle fill="#ef454a91" cx="327" cy="397.5" r="10.5"/>
    <circle fill="#ef454aba" cx="296" cy="392.5" r="10.5"/>
  </g>
<g transform="translate(0,512) scale(0.1,-0.1)" fill="#000000" class="icon_syui">

<path class="syui" d="M3660 4460 c-11 -11 -33 -47 -48 -80 l-29 -60 -12 38 c-27 88 -58 92 -98 11 -35 -70 -73 -159 -73 -169 0 -6 -5 -10 -10 -10 -6 0 -15 -10 -21 -22 -33 -73 -52 -92 -47 -48 2 26 -1 35 -14 38 -16 3 -168 -121 -168 -138 0 -5 -13 -16 -28 -24 -24 -13 -35 -12 -87 0 -221 55 -231 56 -480 56 -219 1 -247 -1 -320 -22 -44 -12 -96 -26 -115 -30 -57 -13 -122 -39 -200 -82 -8 -4 -31 -14 -50 -23 -41 -17 -34 -13 -146 -90 -87 -59 -292 -252 -351 -330 -63 -83 -143 -209 -143 -225 0 -10 -7 -23 -15 -30 -8 -7 -15 -17 -15 -22 0 -5 -13 -37 -28 -71 -16 -34 -36 -93 -45 -132 -9 -38 -24 -104 -34 -145 -13 -60 -17 -121 -17 -300 1 -224 1 -225 36 -365 24 -94 53 -175 87 -247 28 -58 51 -108 51 -112 0 -3 13 -24 28 -48 42 -63 46 -79 22 -85 -11 -3 -20 -9 -20 -14 0 -5 -4 -9 -10 -9 -5 0 -22 -11 -37 -25 -16 -13 -75 -59 -133 -100 -58 -42 -113 -82 -123 -90 -9 -8 -22 -15 -27 -15 -6 0 -10 -6 -10 -13 0 -8 -11 -20 -25 -27 -34 -18 -34 -54 0 -48 14 3 25 2 25 -1 0 -3 -43 -31 -95 -61 -52 -30 -95 -58 -95 -62 0 -5 -5 -8 -11 -8 -19 0 -84 -33 -92 -47 -4 -7 -15 -13 -22 -13 -14 0 -17 -4 -19 -32 -1 -8 15 -15 37 -18 l38 -5 -47 -48 c-56 -59 -54 -81 9 -75 30 3 45 0 54 -11 9 -13 16 -14 43 -4 29 11 30 10 18 -5 -7 -9 -19 -23 -25 -30 -7 -7 -13 -20 -13 -29 0 -12 8 -14 38 -9 20 4 57 8 82 9 25 2 54 8 66 15 18 10 23 8 32 -13 17 -38 86 -35 152 6 27 17 50 34 50 38 0 16 62 30 85 19 33 -15 72 -2 89 30 8 15 31 43 51 62 35 34 38 35 118 35 77 0 85 2 126 33 24 17 52 32 61 32 9 0 42 18 73 40 30 22 61 40 69 40 21 0 88 -26 100 -38 7 -7 17 -12 24 -12 7 0 35 -11 62 -25 66 -33 263 -84 387 -101 189 -25 372 -12 574 41 106 27 130 37 261 97 41 20 80 37 85 39 6 2 51 31 100 64 166 111 405 372 489 534 10 20 22 43 27 51 5 8 12 22 15 30 3 8 17 40 31 70 54 115 95 313 108 520 13 200 -43 480 -134 672 -28 58 -51 108 -51 112 0 3 -13 24 -29 48 -15 24 -34 60 -40 80 -19 57 3 142 50 193 10 11 22 49 28 85 6 36 16 67 21 68 18 6 31 53 25 83 -4 18 -17 33 -36 41 -16 7 -29 15 -29 18 1 10 38 50 47 50 5 0 20 11 33 25 18 19 22 31 17 61 -3 20 -14 45 -23 55 -16 18 -16 20 6 44 15 16 21 32 18 49 -3 15 1 34 8 43 32 43 7 73 -46 55 l-30 -11 0 85 c0 74 -2 84 -18 84 -21 0 -53 -33 -103 -104 l-34 -48 -5 74 c-7 102 -35 133 -80 88z m-870 -740 c36 -7 75 -14 88 -16 21 -4 23 -9 16 -37 -3 -18 -14 -43 -24 -57 -10 -14 -20 -35 -24 -46 -4 -12 -16 -32 -27 -45 -12 -13 -37 -49 -56 -79 -20 -30 -52 -73 -72 -96 -53 -60 -114 -133 -156 -189 -21 -27 -44 -54 -52 -58 -7 -4 -13 -14 -13 -22 0 -7 -18 -33 -40 -57 -22 -23 -40 -46 -40 -50 0 -5 -19 -21 -42 -38 -47 -35 -85 -38 -188 -15 -115 25 -173 20 -264 -23 -45 -22 -106 -46 -136 -56 -48 -15 -77 -25 -140 -50 -70 -28 -100 -77 -51 -84 14 -2 34 -10 45 -17 12 -7 53 -16 91 -20 90 -9 131 -22 178 -57 20 -16 52 -35 70 -43 18 -7 40 -22 49 -32 16 -18 15 -22 -24 -88 -23 -39 -47 -74 -53 -80 -7 -5 -23 -26 -36 -45 -26 -39 -92 -113 -207 -232 -4 -4 -37 -36 -73 -71 l-66 -64 -20 41 c-58 119 -105 240 -115 301 -40 244 -35 409 20 595 8 30 21 66 28 80 7 14 24 54 38 89 15 35 35 75 46 89 11 13 20 31 20 38 0 8 3 14 8 14 4 0 16 16 27 36 24 45 221 245 278 281 23 15 44 30 47 33 20 20 138 78 250 123 61 24 167 50 250 61 60 7 302 -1 370 -14z m837 -661 c52 -101 102 -279 106 -379 2 -42 0 -45 -28 -51 -16 -4 -101 -7 -187 -8 -166 -1 -229 10 -271 49 -19 19 -19 19 14 49 22 21 44 31 65 31 41 0 84 34 84 66 0 30 12 55 56 112 19 25 37 65 44 95 11 51 53 111 74 104 6 -2 25 -32 43 -68z m-662 -810 c17 -10 40 -24 53 -30 12 -7 22 -16 22 -20 0 -4 17 -13 38 -19 20 -7 44 -18 52 -24 8 -7 33 -21 55 -31 22 -11 42 -23 45 -26 11 -14 109 -49 164 -58 62 -11 101 -7 126 14 15 14 38 18 78 16 39 -2 26 -41 -49 -146 -78 -109 -85 -118 -186 -219 -61 -61 -239 -189 -281 -203 -17 -5 -73 -29 -104 -44 -187 -92 -605 -103 -791 -21 -42 19 -47 24 -37 41 5 11 28 32 51 48 22 15 51 38 64 51 13 12 28 22 33 22 17 0 242 233 242 250 0 6 5 10 10 10 6 0 10 6 10 14 0 25 50 55 100 62 59 8 56 6 115 83 50 66 74 117 75 162 0 14 7 40 16 57 18 38 52 41 99 11z"/>
</g>

</svg>
</a>
			</div>
			
		</header>

<article>
	<div class="content">
		
		<div class="post-time-date">2024-10-26 / <a href="https://bsky.syui.ai">@syui</a>

		
		
		<p><i class="fa-regular fa-folder"></i> 
		<a href="https://syui.github.io/tags/cloudflare/">cloudflare</a>
		
		
		
		
		
		, <a href="https://syui.github.io/tags/bluesky/">bluesky</a>
		
		
		
		
		
		, <a href="https://syui.github.io/tags/atproto/">atproto</a>
		
		
		
		
		
		
		
		</div>

		<h2>atprotoのfrontpageを触ってみる</h2>

		<p>前回、live配信にatprotoでoauth loginして掲示板(bbs)に書き込めるサイトを作成し、bbsは簡単にrustで自作したものを使っていました。</p>
<p>しかし、やはり機能的に不足していたのと、公式のoauth exampleがpythonで書かれていたため、python + rustでやっていました。</p>
<p>そこに<a href="https://github.com/likeandscribe/frontpage">likeandscribe/frontpage</a>というものを見つけて、これはいいものだと思ったので触っていきます。</p>
<p>詳しくはこちらを見てください。</p>
<ul>
<li><a href="https://frontpage.fyi/post/tom.frontpage.team/3l6nbjyjmcg2v">https://frontpage.fyi/post/tom.frontpage.team/3l6nbjyjmcg2v</a></li>
</ul>
<p>これがどういったものかというと、おそらく、bsky.socialとは別サービスですがoauthでlogin(signin)でき、投稿情報は自身のpdsに保存されるのでしょう。また、<code>drainpipe</code>はこう書かれています。</p>
<blockquote>
<p>Drainpipe is a atproto firehose consumer written in rust. It knows how to reliably* take messages from the firehose, filter them, and forward them over HTTPs to a webhook receiver some place else on the internet.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ git clone https://github.com/likeandscribe/frontpage
</span></span><span style="display:flex;"><span>$ cd !$:t
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ nvm use <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>$ pnpm i
</span></span><span style="display:flex;"><span>$ cat turbo.json
</span></span><span style="display:flex;"><span>$ pnpm exec turbo run --affected type-check
</span></span></code></pre></div><p>turboを見て分かる通り、dbはtursoを使用するようです。また、<code>drainpipe</code>は<code>fly.io</code>ですね。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>TURSO_CONNECTION_URL
</span></span><span style="display:flex;"><span>TURSO_AUTH_TOKEN
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd packages-rs/drainpipe
</span></span><span style="display:flex;"><span>$ cargo install diesel_cli --no-default-features --features sqlite
</span></span><span style="display:flex;"><span>$ diesel setup
</span></span><span style="display:flex;"><span>$ diesel migration run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cp .env .env.local
</span></span><span style="display:flex;"><span>FRONTPAGE_CONSUMER_SECRET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ docker compose up
</span></span></code></pre></div><p>なお、ubuntuなどrustcのversionが古い場合は<a href="https://rustup.rs/">rustup</a>を使ってpathを設定してください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ rustup update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ~/.zshrc</span>
</span></span><span style="display:flex;"><span>export PATH<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.cargo/bin:</span>$PATH<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>. $HOME/.cargo/env
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd packages/frontpage
</span></span><span style="display:flex;"><span>$ pnpm exec tsx ./scripts/generate-jwk.mts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://docs.turso.tech/quickstart</span>
</span></span><span style="display:flex;"><span>$ turso db create
</span></span><span style="display:flex;"><span>TURSO_CONNECTION_URL
</span></span><span style="display:flex;"><span>TURSO_AUTH_TOKEN
</span></span><span style="display:flex;"><span>DRAINPIPE_CONSUMER_SECRET
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ pnpm run db:generate 
</span></span><span style="display:flex;"><span>$ pnpm run db:migrate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ cloudflared tunnel --url http://localhost:3000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ pnpm run dev
</span></span></code></pre></div><p><img src="https://raw.githubusercontent.com/syui/img/master/other/atproto_frontpage_preview_0001.png" alt=""></p>
<p>基本的に<code>drainpipe</code>を裏で動かします。これがpostを取得したり投稿したりします。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh:packages-rs/drainpipe/.env" data-lang="sh:packages-rs/drainpipe/.env"><span style="display:flex;"><span><span style="color:#75715e"># .env.local</span>
</span></span><span style="display:flex;"><span>- FRONTPAGE_CONSUMER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://localhost:3000/api/receive_hook&#34;</span>
</span></span><span style="display:flex;"><span>+ FRONTPAGE_CONSUMER_URL<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://example.com/api/receive_hook&#34;</span>
</span></span></code></pre></div><h2 id="rewrite">rewrite</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd packages/frontpage
</span></span><span style="display:flex;"><span>$ PUBLIC_URL<span style="color:#f92672">=</span>example.com
</span></span><span style="display:flex;"><span>$ grep -R frontpage.fyi .|cut -d : -f 1|sed -i <span style="color:#e6db74">&#34;s/frontpage.fyi/</span>$PUBLIC_URL<span style="color:#e6db74">/g&#34;</span>
</span></span></code></pre></div><p><code>pnpm run start</code>と<code>pnpm run dev</code>では<code>client_id</code>が異なります。これは<code>/oauth/client-metadata.json</code>を見てください。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-.env" data-lang=".env"><span style="display:flex;"><span><span style="color:#75715e"># .env.local</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># packages/frontpage/lib/auth.ts</span>
</span></span><span style="display:flex;"><span>VERCEL_PROJECT_PRODUCTION_URL<span style="color:#f92672">=</span>example.com
</span></span><span style="display:flex;"><span>VERCEL_BRANCH_URL<span style="color:#f92672">=</span>example.com
</span></span></code></pre></div><h2 id="local-infra">local-infra</h2>
<p>self-hostするのに必要なserver構成だと思います。</p>
<p><a href="https://github.com/likeandscribe/frontpage/tree/main/packages/frontpage/local-infra">https://github.com/likeandscribe/frontpage/tree/main/packages/frontpage/local-infra</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ cd local-infra
</span></span><span style="display:flex;"><span>$ cat README.md
</span></span><span style="display:flex;"><span>docker-compose up
</span></span><span style="display:flex;"><span>Create a test account with ./scripts/create-account.sh &lt;email&gt; &lt;handle&gt;
</span></span><span style="display:flex;"><span>DRAINPIPE_CONSUMER_SECRET<span style="color:#f92672">=</span>secret
</span></span><span style="display:flex;"><span>TURSO_CONNECTION_URL<span style="color:#f92672">=</span>libsql://turso.dev.unravel.fyi
</span></span><span style="display:flex;"><span>PLC_DIRECTORY_URL<span style="color:#f92672">=</span>https://plc.dev.unravel.fyi
</span></span></code></pre></div><p>これらのnameserverはcaddyを見てください。</p>
<p>plcはerrorが出るので、以下のようにします。おそらく、postgresのdatabaseが必要なのでしょう。portsは開けなくて大丈夫です。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml:docker-compose.yml" data-lang="yml:docker-compose.yml"><span style="display:flex;"><span>  <span style="color:#f92672">plc</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">ghcr.io/bluesky-social/did-method-plc:plc-f2ab7516bac5bc0f3f86842fa94e996bd1b3815b</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">plc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#39;4000:8080&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">plc_db</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env_file</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./plc.env</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">plc_db</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">postgres:16-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">always</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">env_file</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./postgres.env</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./configs/postgres/init/:/docker-entrypoint-initdb.d/</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">./data/postgres/:/var/lib/postgresql/data/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">healthcheck</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">test</span>: <span style="color:#e6db74">&#34;pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">interval</span>: <span style="color:#ae81ff">5s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">retries</span>: <span style="color:#ae81ff">20</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh:.env" data-lang="sh:.env"><span style="display:flex;"><span><span style="color:#75715e"># plc.env</span>
</span></span><span style="display:flex;"><span>DEBUG_MODE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>LOG_ENABLED<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>LOG_LEVEL<span style="color:#f92672">=</span>debug
</span></span><span style="display:flex;"><span>LOG_DESTINATION<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>PORT<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>DATABASE_URL<span style="color:#f92672">=</span>postgres://postgres:postgres@plc_db/plc
</span></span><span style="display:flex;"><span>DB_CREDS_JSON<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;username&#34;:&#34;postgres&#34;,&#34;password&#34;:&#34;postgres&#34;,&#34;host&#34;:&#34;plc_db&#34;,&#34;port&#34;:&#34;5432&#34;,&#34;database&#34;:&#34;plc&#34;}&#39;</span>
</span></span><span style="display:flex;"><span>ENABLE_MIGRATIONS<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span>DB_MIGRATE_CREDS_JSON<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;username&#34;:&#34;postgres&#34;,&#34;password&#34;:&#34;postgres&#34;,&#34;host&#34;:&#34;plc_db&#34;,&#34;port&#34;:&#34;5432&#34;,&#34;database&#34;:&#34;plc&#34;}&#39;</span>
</span></span></code></pre></div><h2 id="pds">pds</h2>
<p>大体の原理が理解できてきたので、わかっていることをまとめます。</p>
<p>まずoauth(session)でpdsUrlをgetする感じなのかなと思います。sessionがあれば投稿などは操作できます。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ grep -R pdsUrl .
</span></span><span style="display:flex;"><span>./lib/data/user.ts:  const pdsUrl <span style="color:#f92672">=</span> await getPdsUrl<span style="color:#f92672">(</span>session.user.did<span style="color:#f92672">)</span>;
</span></span></code></pre></div><p>あるいは<code>ws://pds:3000</code>を使用する可能性も考えられますが、基本は<code>bsky.network</code>を使うのだと思います。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh:packages-rs/drainpipe/.env" data-lang="sh:packages-rs/drainpipe/.env"><span style="display:flex;"><span>RELAY_URL<span style="color:#f92672">=</span>wss://bsky.network
</span></span></code></pre></div><p>次に<code>unravel.frontpage</code>についてです。これは主に<code>collection</code>に書き込まれているようです。この場合、<code>frontpage.fyi</code>と投稿は共通します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ grep -R unravel.frontpage ./app ./lib
</span></span><span style="display:flex;"><span>./app/api/receive_hook/route.ts:    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>collection <span style="color:#f92672">===</span> <span style="color:#e6db74">&#34;fyi.unravel.frontpage.vote&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>./lib/data/atproto/comment.ts:export const CommentCollection <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fyi.unravel.frontpage.comment&#34;</span>;
</span></span><span style="display:flex;"><span>./lib/data/atproto/vote.ts:    collection: <span style="color:#e6db74">&#34;fyi.unravel.frontpage.vote&#34;</span>,
</span></span><span style="display:flex;"><span>./lib/data/atproto/vote.ts:    collection: <span style="color:#e6db74">&#34;fyi.unravel.frontpage.vote&#34;</span>,
</span></span><span style="display:flex;"><span>./lib/data/atproto/event.ts:  z.literal<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fyi.unravel.frontpage.vote&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>./lib/data/atproto/post.ts:export const PostCollection <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;fyi.unravel.frontpage.post&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># HOST_REVERT=com.unravel.example</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># grep -R unravel.frontpage ./app ./lib |cut -d : -f 1|xargs sed -i &#34;s/fyi.unravel.frontpage/${HOST_REVERT}/g&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// https://atproto.com/ja/guides/applications
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// レコードの時間ベースのキーを生成します
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rkey</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">TID</span>.<span style="color:#a6e22e">nextStr</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 書き込み
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">com</span>.<span style="color:#a6e22e">atproto</span>.<span style="color:#a6e22e">repo</span>.<span style="color:#a6e22e">putRecord</span>({
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">repo</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">agent</span>.<span style="color:#a6e22e">assertDid</span>, <span style="color:#75715e">// ユーザー
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">collection</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;xyz.statusphere.status&#39;</span>, <span style="color:#75715e">// コレクション
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">rkey</span>, <span style="color:#75715e">// レコード キー
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">record</span><span style="color:#f92672">:</span> { <span style="color:#75715e">// レコード値
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">status</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;👍&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">createdAt</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> Date().<span style="color:#a6e22e">toISOString</span>()
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p><code>drainpipe</code>はpdsの<code>fyi.unravel.frontpage(collection)</code>を検索してfirehoseの<code>subscribeRepos</code>にcommitするようです。この2つの部分を変更すると<code>frontpage.fyi</code>と連動しません。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust:packages-rs/drainpipe/src/main.rs" data-lang="rust:packages-rs/drainpipe/src/main.rs"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> ws_request <span style="color:#f92672">=</span> format!(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">/xrpc/com.atproto.sync.subscribeRepos</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        relay_url, query_string
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// https://github.com/likeandscribe/frontpage/blob/e7444ec6c19f0ccef3776f04702c3bb033ed3bfc/packages-rs/drainpipe/src/main.rs#L66-L97
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">/// Process a message from the firehose. Returns the sequence number of the message or an error.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"></span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">process</span>(message: Vec<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u8</span><span style="color:#f92672">&gt;</span>, ctx: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> Context) -&gt; Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">i64</span>, ProcessError<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> (_header, data) <span style="color:#f92672">=</span> firehose::read(<span style="color:#f92672">&amp;</span>message).map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> ProcessError {
</span></span><span style="display:flex;"><span>        inner: <span style="color:#a6e22e">e</span>.into(),
</span></span><span style="display:flex;"><span>        seq: <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>        source: <span style="color:#a6e22e">message</span>.clone().into(),
</span></span><span style="display:flex;"><span>        kind: <span style="color:#a6e22e">ProcessErrorKind</span>::DecodeError,
</span></span><span style="display:flex;"><span>    })<span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> sequence <span style="color:#f92672">=</span> <span style="color:#66d9ef">match</span> data {
</span></span><span style="display:flex;"><span>        firehose::SubscribeRepos::Commit(commit) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> frontpage_ops <span style="color:#f92672">=</span> commit
</span></span><span style="display:flex;"><span>                .operations
</span></span><span style="display:flex;"><span>                .iter()
</span></span><span style="display:flex;"><span>                .filter(<span style="color:#f92672">|</span>op<span style="color:#f92672">|</span> op.path.starts_with(<span style="color:#e6db74">&#34;com.unravel.example.&#34;</span>))
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//.filter(|op| op.path.starts_with(&#34;fyi.unravel.frontpage.&#34;))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                .collect::<span style="color:#f92672">&lt;</span>Vec<span style="color:#f92672">&lt;</span>_<span style="color:#f92672">&gt;&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span>frontpage_ops.is_empty() {
</span></span><span style="display:flex;"><span>                process_frontpage_ops(<span style="color:#f92672">&amp;</span>frontpage_ops, <span style="color:#f92672">&amp;</span>commit, <span style="color:#f92672">&amp;</span>ctx)
</span></span><span style="display:flex;"><span>                    .map_err(<span style="color:#f92672">|</span>e<span style="color:#f92672">|</span> ProcessError {
</span></span><span style="display:flex;"><span>                        seq: <span style="color:#a6e22e">commit</span>.sequence,
</span></span><span style="display:flex;"><span>                        inner: <span style="color:#a6e22e">e</span>,
</span></span><span style="display:flex;"><span>                        source: <span style="color:#a6e22e">message</span>.clone().into(),
</span></span><span style="display:flex;"><span>                        kind: <span style="color:#a6e22e">ProcessErrorKind</span>::ProcessError,
</span></span><span style="display:flex;"><span>                    })
</span></span><span style="display:flex;"><span>                    .<span style="color:#66d9ef">await</span><span style="color:#f92672">?</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            commit.sequence
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        msg <span style="color:#f92672">=&gt;</span> msg.sequence(),
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Ok(sequence)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>ただ、infraのpdsは<code>pds.dev.unravel.fyi</code>となっていて、中の人の話を聞くと<code>frontpage.fyi</code>のpdsにpostされるように感じました。</p>


		

	</div>

</article>


<div class="comment">
	<p><a href="https://o.syui.ai/post/syui.ai/3lafos6to6y2y" class="frontpage-button"> @comment </a></p>
	<iframe class="frontpage" src="https://o.syui.ai/post/syui.ai/3lafos6to6y2y" frameBorder="0" SRC=""></iframe>
</div>



</div>
		<div class="footer-link">
	<span class="footer-link"><a href="https://syu.is/syui" target="_blank"><i class="fab fa-bluesky"></i></a></span>
		<span class="footer-link"><a href="https://card.syui.ai/syui" target="_blank"><span class="icon-ai"></span></a></span>
	<span class="footer-link"><a href="https://git.syui.ai/syui" target="_blank"><span class="icon-git"></span></a></span>
</div>

<script src="/js/svg.js"></script>
<script src="/js/highlight-filename.js"></script>
<footer id="footer">© syui</footer>

	</body>
</html>
