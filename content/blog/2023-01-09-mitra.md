+++
date = "2023-01-09"
tags = ["rust","activitypub","sns"]
title = "mitraをfly.ioでdeployしてみた"
slug = "mitra"
+++

mitraは、rustで書かれた仮想通貨のwalletと連携可能なインスタンスです。

https://codeberg.org/silverpill/mitra

https://codeberg.org/silverpill/mitra-web

gotosocialに似ていて、matrixの設計を参考にしているように感じられます。

```sh
$ git clone https://codeberg.org/silverpill/mitra
$ cd mitra
$ cp config.yaml.example config.yaml
$ cargo build --release --features production
$ cat .env.local
ENVIRONMENT=development
#ENVIRONMENT=production
CONFIG_PATH=./config.yaml
#CONFIG_PATH=/app/server/config.yaml
#VUE_APP_BACKEND_URL=https://xxx:8383

$ git clone https://codeberg.org/silverpill/mitra-web
$ cd mitra-web
$ npm install --no-save
$ npx allow-scripts
$ npm run build
$ mv dist ../
```

```yaml:config.yaml
database_url: postgres://mitra:mitra@127.0.0.1:55432/mitra
storage_dir: files
web_client_dir: dist
http_host: '127.0.0.1'
http_port: 8380
instance_uri: xxx:8380
instance_title: Mitra
instance_short_description: My instance
instance_description: My instance
registrations_open: true
```

```sh
$ docker-compose up -d
$ ./target/release/mitra
```

fly.ioのdockerでやろうと思うと、けっこう大変です。

`.dockerignore`に`mitra/{target,files}`を追加しておいてください。

> Dockerfile 

```sh
FROM rust:latest as builder

WORKDIR /app
ADD mitra/ ./

RUN cargo build --release --features production
RUN mv target/release/mitra ./
RUN mv target/release/mitractl ./

RUN mkdir -p /app/files
```

```toml:fly.toml
app = "xxx"
kill_signal = "SIGINT"
kill_timeout = 10
processes = []

[env]
PORT = "8380"

[experimental]
cmd = "./mitra"

[[services]]
  internal_port = 8380
  protocol = "tcp"

  [services.concurrency]
    hard_limit = 100
    soft_limit = 80

  [[services.ports]]
    handlers = ["tls", "http"]
    port = "443"

  [[services.ports]]
    handlers = ["tls", "http"]
    port = "5001"

  [[services.ports]]
    handlers = ["tls", "http"]
    port = "8001"

  [[services.tcp_checks]]
    interval = "10s"
    grace_period = "5s"
    timeout = "2s"

[mounts]
source="xxx_data"
destination="/app/files"
```

### deploy

```sh
$ flyctl deploy --remote-only
```

- https://github.com/fly-apps/hello-rust

- https://community.fly.io/t/error-deploying-fly-apps-hello-rust/5664

### ips

```sh:.env.local
#ENVIRONMENT=development
ENVIRONMENT=production
CONFIG_PATH=./config.yaml
VUE_APP_BACKEND_URL=http://example.com:8380
PORT=8381
```

```yaml:config.yaml
ipfs_api_url: 'http://127.0.0.1:5001'
ipfs_gateway_url: 'http://127.0.0.1:8001'
```

```sh
$ fly ips list
$ flyctl ips release 12.34.56.78
```

- https://community.fly.io/t/announcement-shared-anycast-ipv4/9384

### node

m1だとcompileしないといけないらしい。

```sh
$ nvm install v14
$ nvm use v14
```

