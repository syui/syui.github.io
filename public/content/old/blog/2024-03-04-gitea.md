+++
date = "2024-03-04"
tags = ["gitea"]
title = "gitea actionsã«ç§»è¡Œã™ã‚‹ã‹ã‚‚"
slug = "gitea"
+++

`gitea actions`ã¨ã„ã†ã®ã¯ã€`github actions`ã¨ã‹`gitlab-ci`ã¨å‘¼ã°ã‚Œã‚‹ã‚‚ã®ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ãªã‚“ã ã‘ã©ã€æœ‰åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹è¿·ã£ã¦ã„ã¾ã—ãŸã€‚

ã¨ã„ã†ã®ã‚‚serverã®è² æ‹…ãŒå¢—å¤§ã™ã‚‹ã—ã€ã„ãã¤ã‚‚ã®serviceã‚’å‹•ä½œã•ã›ã¦ã„ã‚‹ç’°å¢ƒã ã¨ã€ãã‚Œãã‚Œã®åå¿œãŒã©ã†ã—ã¦ã‚‚é…ããªã£ã¦ã—ã¾ã†ã‹ã‚‰ã§ã™ã€‚

ã—ãŸãŒã£ã¦ã€ã“ã†ã„ã†ã®ã¯å…¨éƒ¨ç„¡æ–™ã§ä½¿ãˆã‚‹githubã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒä¸€ç•ªã§ã—ãŸã€‚

ã—ã‹ã—ã€æœ€è¿‘ã«ãªã£ã¦username(id)ã®é–¢ä¿‚ã§giteaã‚’ä½¿ã†é »åº¦ãŒå¢—ãˆã¦ããŸã®ã§ã€`gitea actions`ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

githubã§ã¯ä½¿ã„ãŸã„username(id)ãŒã™ã§ã«å–ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¤šãã€æ™‚ä»£ã¯self-hostã‚„domainã«ãªã£ã¦ã„ãã®ã ã‚ã†ãªã‚ã¨ã€ãã‚“ãªãµã†ã«æ€ã„ã¾ã™ã€‚

ç§ã®å ´åˆã€æœ€è¿‘ã«ãªã£ã¦reposã‚’æ•´ç†ã—ãŸã“ã¨ã‚‚ã‚ã‚Šã€ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã¯çµæ§‹æ°—ã«ãªã‚Šã¾ã™ã€‚

ä¾‹ãˆã°ã€æœ€è¿‘ä½œã£ãŸè‡ªä½œosã¯`ai os`ã¨ã„ã†åå‰ã§ã™ãŒã€`username/aios`ã§ã¯ãªãã€`ai/os`ã¨ã„ã†ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ãŸã‹ã£ãŸã€‚

- o `git@git.syui.ai:ai/os.git`
- x `git@github.com:username/aios.git`

ã¨ã¯ã„ãˆã€ã“ã‚Œã‚‚ã¡ã‚‡ã£ã¨åˆ†ã‹ã‚Šã¥ã‚‰ã„ã§ã™ã‚ˆã­ã€‚æœ¬æ¥ã¯`ai/aios`ã¨ã‹ã®ã»ã†ãŒã‚ã‹ã‚Šã‚„ã™ã„ã‹ãªã€‚ã¾ã‚ã€å¥½ã¿ã®å•é¡Œã¨ã„ã†ã“ã¨ã«ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

## gitea actionsã®æ§‹ç¯‰

`gitea ci`ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚

https://blog.gitea.com/hacking-on-gitea-actions/

```sh:/app/data/gitea/conf/app.ini
[actions]
ENABLED=true
```

web-uiã§settingã‹ã‚‰actionsã®tokenã‚’å–å¾—ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

```sh
$ git clone https://gitea.com/gitea/act_runner
$ cd act_runner
$ make build
$ ./act_runner register
$ ./act_runner daemon

# nohup ./act_runner daemon &
```

ã“ã‚Œã§ä½¿ãˆã‚‹ã¯ãšã€‚statusãŒã‚¢ã‚¤ãƒ‰ãƒ«ã«ãªã‚Šã¾ã™ã€‚

![](/img/gitea-ci_0001.png)

ã‚ã¨ã¯gh-actionsã¨åŒã˜ã‚ˆã†ã«repoã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç½®ã„ã¦`push`ã—ã¾ã™ã€‚

```yml:.gitea/workflows/demo.yaml
name: Gitea Actions Demo
run-name: ${{ gitea.actor }} is testing out Gitea Actions ğŸš€
on: [push]
jobs:
  Explore-Gitea-Actions:
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ‰ The job was automatically triggered by a ${{ gitea.event_name }} event."
      - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by Gitea!"
      - run: echo "ğŸ” The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "ğŸ’¡ The ${{ gitea.repository }} repository has been cloned to the runner."
      - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls ${{ gitea.workspace }}
      - run: echo "ğŸ This job's status is ${{ gitea.status }}."
```

## docker images(container registry)

docker imagesã®ç½®ãå ´æ‰€ã¨ã—ã¦docker hub(dockerhub)ãŒæœ€ã‚‚æ”¯é…çš„ã§ã€ã‹ã¤ä½¿ã„ã‚„ã™ã„ã§ã™ã€‚

ãªãœãªã‚‰ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§dockerhubãŒæŒ‡å®šã•ã‚Œã‚‹ã‹ã‚‰ã§ã™ã€‚

ãŸã ã€`github packages(ghcr.io)`ã«ç½®ã„ã¦ã‚ã‚‹ã“ã¨ã‚‚å¢—ãˆã¦ãã¦ã€`github actions`ã®å½±éŸ¿ãŒå¤§ãã„ã¨æ€ã„ã¾ã™ã€‚

```sh
$ docker run -it syui/aios ai
$ docker run -it ghcr.io/syui/aios ai
```

ã—ã‹ã—ã€ä»Šã¾ã§`syui/aios`ã‚’ä½¿ã£ã¦ã„ã¾ã—ãŸãŒã€`gitea actions`ã‚’æœ‰åŠ¹ã«ã—ãŸã“ã¨ã§`ai/os`ã«ç½®ãæ›ãˆã‚„ã™ããªã‚Šã¾ã™ã€‚ã¨ã„ã†ã‹ã€æœ‰åŠ¹ã«ã—ãŸã®ã¯ã€ä¸»ã«ã“ã‚Œã®ãŸã‚ã§ã™ã€‚

```sh
$ docker tag syui/aios git.syui.ai/ai/os
$ docker push git.syui.ai/ai/os
```

```sh
$ docker run -it git.syui.ai/ai/os ai
```

ãŸã ã€docker imagesã¯æœ¬å½“ã«å®¹é‡ã‚’é£Ÿã†ã®ã§ã€ã‚ã¾ã‚ŠãŠã™ã™ã‚ã§ããªã„ã€‚dockerhubã«ç½®ãã®ãŒä¸€ç•ªã§ã—ã‚‡ã†ã€‚

ç§ã®å ´åˆã€repoã‚’giteaã«ç§»è¡Œã—ãŸã®ã«ã€dockerã ã‘github, dockerhubãªã®ã¯ã‚ã¾ã‚Šè‰¯ããªã„ã€‚ãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ãŒç•°ãªã‚‹ã®ãŒè‰¯ããªã„ã€‚dockerã‚‚giteaã«ç§»è¡Œã™ã‚‹ã‹ã‚‚ã€‚

ãªã‚“ã‹2GBã‚’è¶…ãˆãŸã‚ãŸã‚Šã§pushã§ããªããªã‚Šã¾ã™ã€‚

> received unexpected HTTP status: 500 Internal Server Error

```sh
The push refers to repository [***/divya.jain/homer]
994393dc58e7: Pushed 
received unexpected HTTP status: 500 Internal Server Error
```

- https://github.com/go-gitea/gitea/issues/21320

ã—ãŸãŒã£ã¦ã€localhostã‹ã‚‰pushã—ã¾ã™ã€‚

## actions runner

- https://docs.gitea.com/usage/actions/act-runner#labels

- https://forum.gitea.com/t/gitea-actions-cannot-find-node-in-path/7544/6

> OCI runtime exec failed: exec failed: unable to start container process: exec: "node": executable file not found in $PATH: unknown

nodeã‚’docker(gitea-runner)ã«installã—ã¦ã‚‚checkoutã®ã¨ãã«errãŒå‡ºã¾ã™ã€‚

ãŸã ã€`runs-on: ubuntu-latest`ã®ã¿ãªã‚‰errãŒã§ã¾ã›ã‚“ã€‚ã—ãŸãŒã£ã¦ã€ã“ã‚Œã¯`container: archlinux`ãŒå•é¡Œãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã©ã¡ã‚‰ã«ã›ã‚ˆarchisoã¯archlinuxã§å®Ÿè¡Œã—ã¾ã™ã®ã§ã€nodeã‚’installã—ãŸ`container: syui/aios`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```yaml
    runs-on: ubuntu-latest
    container: 
      #image: archlinux
      image: syui/aios 
```

